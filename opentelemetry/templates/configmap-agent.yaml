{{- /*
  Génère le ConfigMap AGENT avec filtrage automatique des fragments
  en fonction de agentPipelinesFile.
*/ -}}

{{- $conf := dict
  "receivers"  dict
  "processors" dict
  "exporters"  dict
  "connectors" dict
-}}

{{- $dirs := dict
  "receivers"  .Values.receiversDir
  "processors" .Values.processorsDir
  "exporters"  .Values.exportersDir
  "connectors" .Values.connectorsDir
-}}

  # Fusion initiale des fragments
{{- range $kind, $path := $dirs }}
  {{- $files := $.Files.Glob (printf "%s/*.y*ml" $path) }}
  {{- range $filePath, $fileContent := $files }}
    {{- $yaml := fromYaml (toString $fileContent) }}
    {{- if $yaml }}
      {{- $_ := set $conf $kind (merge (get $conf $kind) $yaml) }}
    {{- end }}
  {{- end }}
{{- end }}

  # Pipelines AGENT
{{- $pipelines := fromYaml (.Files.Get .Values.agentPipelinesFile) }}

  # Extraction des éléments réellement utilisés
{{- $usedReceivers := list }}
{{- $usedProcessors := list }}
{{- $usedExporters := list }}

{{- range $pName, $pConf := $pipelines.pipelines }}
  {{- range $r := $pConf.receivers }}
    {{- $usedReceivers = append $usedReceivers $r }}
  {{- end }}
  {{- range $pr := $pConf.processors }}
    {{- $usedProcessors = append $usedProcessors $pr }}
  {{- end }}
  {{- range $e := $pConf.exporters }}
    {{- $usedExporters = append $usedExporters $e }}
  {{- end }}
{{- end }}

  # Filtrage des fragments
{{- $filteredReceivers := dict }}
{{- range $name, $item := (get $conf "receivers") }}
  {{- if mustHas $name $usedReceivers }}
    {{- $_ := set $filteredReceivers $name $item }}
  {{- end }}
{{- end }}

{{- $filteredProcessors := dict }}
{{- range $name, $item := (get $conf "processors") }}
  {{- if mustHas $name $usedProcessors }}
    {{- $_ := set $filteredProcessors $name $item }}
  {{- end }}
{{- end }}

{{- $filteredExporters := dict }}
{{- range $name, $item := (get $conf "exporters") }}
  {{- if mustHas $name $usedExporters }}
    {{- $_ := set $filteredExporters $name $item }}
  {{- end }}
{{- end }}

  # Connectors utilisés uniquement s'ils apparaissent en receiver ou exporter
{{- $filteredConnectors := dict }}
{{- range $name, $item := (get $conf "connectors") }}
  {{- if or (mustHas $name $usedReceivers) (mustHas $name $usedExporters) }}
    {{- $_ := set $filteredConnectors $name $item }}
  {{- end }}
{{- end }}

  # Construction finale du fichier agent
{{- $agentConfig := dict
  "receivers"  $filteredReceivers
  "processors" $filteredProcessors
  "exporters"  $filteredExporters
  "connectors" $filteredConnectors
  "service"    $pipelines
-}}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-agent-configmap
  namespace: {{ .Values.namespace }}
data:
  config.yaml: |
{{ toYaml $agentConfig | indent 4 }}